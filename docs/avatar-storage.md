# 头像存储实现指南

本文档介绍了 BenChat 应用中用户头像存储的实现方案。

## 存储方式

BenChat 使用 Supabase 存储服务来存储用户头像。相较于之前使用的 localStorage 方案，服务器存储有以下优势：

1. 可持久化存储，不会随浏览器缓存清除而丢失
2. 减轻浏览器存储负担，不占用客户端存储空间
3. 支持多设备访问同一头像
4. 更好的性能和可扩展性

## 技术实现

### 后端实现

1. **Supabase 存储桶**：创建名为 `user-uploads` 的公共存储桶
2. **安全策略**：
   - 只允许已认证用户上传头像
   - 头像文件可公开访问
   - 用户只能删除自己的头像
3. **用户资料表**：在 `profiles` 表中增加 `avatar_url` 字段存储头像 URL

### 前端实现

1. **上传流程**：
   - 用户选择图片文件
   - 前端验证文件大小（<2MB）和类型
   - 创建本地预览（Base64）
   - 通过 API 上传到服务器
   - 更新用户资料中的 avatar_url

2. **API 端点**：
   - `/api/upload-avatar` 处理文件上传
   - 文件名格式：`avatar_{userId}_{timestamp}.{extension}`
   - 上传成功后返回公共 URL

3. **上下文管理**：
   - 使用 `UserConfigContext` 管理头像 URL
   - 提供 `refreshUserAvatar` 方法从服务器获取最新头像
   - 在应用启动时自动刷新头像

## 头像显示优先级

1. 首先尝试显示服务器存储的头像（`userAvatarUrl`）
2. 如果服务器头像不可用，显示本地临时头像（`userAvatar`，Base64格式）
3. 如果两者都不可用，显示用户名首字母作为占位符

## 安全考虑

1. 文件大小限制：最大 2MB
2. 文件类型限制：仅接受图片文件
3. 用户认证：必须登录才能上传头像
4. 权限隔离：用户只能管理自己的头像

## 错误处理

1. 上传失败时显示错误消息
2. 加载失败时降级到占位符显示
3. 网络问题时保留本地缓存版本

## 后续优化

1. 添加图片裁剪功能
2. 实现更精细的头像压缩
3. 支持渐进式加载
4. 添加头像删除功能
